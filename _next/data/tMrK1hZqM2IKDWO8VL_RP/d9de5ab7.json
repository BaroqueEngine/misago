{"pageProps":{"post":{"title":"操舵行動の基本","slug":"d9de5ab7","content":"<h2>実行例</h2>\n<p><img src=\"./static/images/d9de5ab7/0.png\" alt=\"\">\n<a href=\"./static/play/d9de5ab7/index.html\">実行結果を見る</a></p>\n<h2>ソースコード</h2>\n<h3>TypeScript</h3>\n<p><a href=\"./static/code/d9de5ab7/vehicle.ts\">vehicle.ts</a> / <a href=\"./static/code/d9de5ab7/app.ts\">app.ts</a></p>\n<h2>解説/アルゴリズム</h2>\n<ol>\n<li>追いかける/逃げるなどの各動作に対応する加速度を与える</li>\n<li>加速度をもとに速度を更新</li>\n<li>速度をもとに位置を更新</li>\n<li>加速度を初期化する</li>\n</ol>\n<p>詳細は後述しますが、操舵行動でのオブジェクトの基本的な動きは上記の手順となります。</p>\n<pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token keyword\">export</span> <span class=\"token keyword\">type</span> <span class=\"token class-name\">Vehicle</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  position<span class=\"token operator\">:</span> p5<span class=\"token punctuation\">.</span>Vector<span class=\"token punctuation\">;</span> <span class=\"token comment\">// 位置</span>\n  velocity<span class=\"token operator\">:</span> p5<span class=\"token punctuation\">.</span>Vector<span class=\"token punctuation\">;</span> <span class=\"token comment\">// 速度</span>\n  acceleration<span class=\"token operator\">:</span> p5<span class=\"token punctuation\">.</span>Vector<span class=\"token punctuation\">;</span> <span class=\"token comment\">// 加速度</span>\n  maxSpeed<span class=\"token operator\">:</span> <span class=\"token builtin\">number</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 最大速度</span>\n  maxForce<span class=\"token operator\">:</span> <span class=\"token builtin\">number</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 最大加速度</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n</code></pre>\n<p>操舵行動に必要なオブジェクトのプロパティです。</p>\n<pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token keyword\">export</span> <span class=\"token keyword\">function</span> <span class=\"token function\">run</span><span class=\"token punctuation\">(</span>v<span class=\"token operator\">:</span> Vehicle<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token keyword\">void</span> <span class=\"token punctuation\">{</span>\n  v<span class=\"token punctuation\">.</span>acceleration<span class=\"token punctuation\">.</span><span class=\"token keyword\">set</span><span class=\"token punctuation\">(</span><span class=\"token number\">10</span><span class=\"token punctuation\">,</span> <span class=\"token number\">10</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n</code></pre>\n<p>追いかける/逃げるなどの各動作に対して、加速度を与えるのですが、今回は単純な動きだけでいいので、加速度に固定値を入れます。</p>\n<pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token keyword\">export</span> <span class=\"token keyword\">function</span> <span class=\"token function\">update</span><span class=\"token punctuation\">(</span>p<span class=\"token operator\">:</span> p5<span class=\"token punctuation\">,</span> v<span class=\"token operator\">:</span> Vehicle<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token keyword\">void</span> <span class=\"token punctuation\">{</span>\n  v<span class=\"token punctuation\">.</span>acceleration<span class=\"token punctuation\">.</span><span class=\"token function\">limit</span><span class=\"token punctuation\">(</span>v<span class=\"token punctuation\">.</span>maxForce<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 加速度が最大加速度を超えないようにする</span>\n  v<span class=\"token punctuation\">.</span>velocity<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span>v<span class=\"token punctuation\">.</span>acceleration<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 速度に加速度を足して更新</span>\n  v<span class=\"token punctuation\">.</span>velocity<span class=\"token punctuation\">.</span><span class=\"token function\">limit</span><span class=\"token punctuation\">(</span>v<span class=\"token punctuation\">.</span>maxSpeed<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 速度が最大速度を超えないようにする</span>\n  v<span class=\"token punctuation\">.</span>position<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span>v<span class=\"token punctuation\">.</span>velocity<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 位置に速度を足して更新</span>\n  v<span class=\"token punctuation\">.</span>acceleration<span class=\"token punctuation\">.</span><span class=\"token keyword\">set</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 加速度をリセット</span>\n\n  <span class=\"token comment\">// 画面端の処理（後述）</span>\n  <span class=\"token function\">adjustEdge</span><span class=\"token punctuation\">(</span>p<span class=\"token punctuation\">,</span> v<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n</code></pre>\n<p>毎フレーム呼び出される update 関数では、加速度を足して速度の更新を、速度を足して位置の更新を行います。</p>\n<p>加速度/速度はそれぞれ上限があり、その値を超えないように調整を行います。\nこの調整を行うことで無尽蔵に速度が増える続けることはありませんし、急に曲がるような動きをしなくなるので、より動物らしい動きになります。</p>\n<p>加速度は毎フレーム初期化する必要があるため、速度に足し合わせた後、0 を代入します。</p>\n<pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token keyword\">export</span> <span class=\"token keyword\">function</span> <span class=\"token function\">adjustEdge</span><span class=\"token punctuation\">(</span>p<span class=\"token operator\">:</span> p5<span class=\"token punctuation\">,</span> v<span class=\"token operator\">:</span> Vehicle<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token keyword\">void</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// x軸で画面からはみ出たら画面内に戻して速度のx成分を反転する</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>v<span class=\"token punctuation\">.</span>position<span class=\"token punctuation\">.</span>x <span class=\"token operator\">&lt;</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    v<span class=\"token punctuation\">.</span>position<span class=\"token punctuation\">.</span>x <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n    v<span class=\"token punctuation\">.</span>velocity<span class=\"token punctuation\">.</span>x <span class=\"token operator\">*=</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>v<span class=\"token punctuation\">.</span>position<span class=\"token punctuation\">.</span>x <span class=\"token operator\">>=</span> p<span class=\"token punctuation\">.</span>windowWidth<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    v<span class=\"token punctuation\">.</span>position<span class=\"token punctuation\">.</span>x <span class=\"token operator\">=</span> p<span class=\"token punctuation\">.</span>windowWidth <span class=\"token operator\">-</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n    v<span class=\"token punctuation\">.</span>velocity<span class=\"token punctuation\">.</span>x <span class=\"token operator\">*=</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token comment\">// y軸で画面からはみ出たら画面内に戻して速度のy成分を反転する</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>v<span class=\"token punctuation\">.</span>position<span class=\"token punctuation\">.</span>y <span class=\"token operator\">&lt;</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    v<span class=\"token punctuation\">.</span>position<span class=\"token punctuation\">.</span>y <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n    v<span class=\"token punctuation\">.</span>velocity<span class=\"token punctuation\">.</span>y <span class=\"token operator\">*=</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>v<span class=\"token punctuation\">.</span>position<span class=\"token punctuation\">.</span>y <span class=\"token operator\">>=</span> p<span class=\"token punctuation\">.</span>windowHeight<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    v<span class=\"token punctuation\">.</span>position<span class=\"token punctuation\">.</span>y <span class=\"token operator\">=</span> p<span class=\"token punctuation\">.</span>windowHeight <span class=\"token operator\">-</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n    v<span class=\"token punctuation\">.</span>velocity<span class=\"token punctuation\">.</span>y <span class=\"token operator\">*=</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n</code></pre>\n<p>オブジェクトが画面外に移動して消えた場合、跳ね返ったり、反対側から出てくるなどの処理で画面内に戻します。<br>\n上記では跳ね返る処理を実装しています。</p>\n<pre class=\"language-typescript\"><code class=\"language-typescript\">p<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">setup</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  p<span class=\"token punctuation\">.</span><span class=\"token function\">createCanvas</span><span class=\"token punctuation\">(</span>p<span class=\"token punctuation\">.</span>windowWidth<span class=\"token punctuation\">,</span> p<span class=\"token punctuation\">.</span>windowHeight<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token comment\">// 初期位置、初期速度、最大速度、最大加速度を与えてオブジェクトを生成する</span>\n  <span class=\"token keyword\">const</span> position <span class=\"token operator\">=</span> p<span class=\"token punctuation\">.</span><span class=\"token function\">createVector</span><span class=\"token punctuation\">(</span><span class=\"token number\">100</span><span class=\"token punctuation\">,</span> <span class=\"token number\">100</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> velocity <span class=\"token operator\">=</span> p<span class=\"token punctuation\">.</span><span class=\"token function\">createVector</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> maxSpeed <span class=\"token operator\">=</span> <span class=\"token number\">8</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> maxForce <span class=\"token operator\">=</span> <span class=\"token number\">0.1</span><span class=\"token punctuation\">;</span>\n  vehicle <span class=\"token operator\">=</span> <span class=\"token function\">init</span><span class=\"token punctuation\">(</span>p<span class=\"token punctuation\">,</span> position<span class=\"token punctuation\">,</span> velocity<span class=\"token punctuation\">,</span> maxSpeed<span class=\"token punctuation\">,</span> maxForce<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\np<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">draw</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// 画面クリア</span>\n  p<span class=\"token punctuation\">.</span><span class=\"token function\">background</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"#02121e\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token function\">run</span><span class=\"token punctuation\">(</span>vehicle<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 加速度を与える</span>\n  <span class=\"token function\">update</span><span class=\"token punctuation\">(</span>p<span class=\"token punctuation\">,</span> vehicle<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 加速度をもとに速度、速度をもとに位置を更新する</span>\n  <span class=\"token function\">draw</span><span class=\"token punctuation\">(</span>p<span class=\"token punctuation\">,</span> vehicle<span class=\"token punctuation\">,</span> <span class=\"token string\">\"#aaa\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 位置をもとにオブジェクトを描画する</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n</code></pre>\n<p>実際に Vehicle オブジェクトを生成して、扱う例となります。</p>\n"}},"__N_SSG":true}